<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Minimal Elixir Web Application with Plug and Cowboy</title>
  <meta name="description" content="It is interesting to learn things from scratch. Coming from Ruby background, I was curious what is the equivalent of Sinatra in Elixir. It’s called Plug. It ...">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://old.kaiwern.com/elixir/2018/10/14/minimal-web-application-with-plug-and-cowboy.html">
  <link rel="alternate" type="application/rss+xml" title="kw7oe" href="/feed.xml">

  
</head>


  <body>

    <header class="site-header" role="banner">
  <div class="main-col">
    
    

    
      <nav class="navbar" role="navigation"
        aria-label="main navigation">
        

<div class="navbar-brand">
<a href="/"
   >
  Home
</a>
</div>

        

<div class="navbar-item">
<a href="/categories"
   >
  Categories
</a>
</div>

        

<div class="navbar-item">
<a href="/about"
   >
  About
</a>
</div>

      </nav>
      
  </div>
</header>


    <div class="section">
  <main class="main-col" aria-label="Content">
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Minimal Elixir Web Application with Plug and Cowboy</h1>
    <small class="post-meta">
      <time datetime="2018-10-14T15:32:00+08:00" itemprop="datePublished">
        
        Oct 14, 2018
      </time>
      </small>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>It is interesting to learn things from scratch. Coming from Ruby
background, I was curious what is the equivalent of Sinatra in
Elixir. It’s called Plug. It is what Phoenix build on top of.</p>

<p>Using Sinatra, we can write a quick and simple web server with the following
code:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra'</span>
<span class="nb">require</span> <span class="s1">'json'</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">content_type</span> <span class="ss">:json</span>
  <span class="no">JSON</span><span class="p">({</span><span class="ss">message: </span><span class="s2">"Hello World"</span><span class="p">})</span>
<span class="k">end</span>
</code></pre></div></div>

<p>How can we achive that in Elixir? With <code class="highlighter-rouge">Plug</code> and <code class="highlighter-rouge">Cowboy</code>.</p>

<h2 id="setup">Setup</h2>

<p><em><strong>NOTE</strong>: This article is based on Elixir v1.7.3</em></p>

<p>First of all, let’s create a <code class="highlighter-rouge">mix</code> project and change directory into it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mix new sample_app
<span class="nb">cd </span>sample_app
</code></pre></div></div>

<p>Open <code class="highlighter-rouge">mix.exs</code> file with your favourite editor. And add the dependencies as
follow:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defp</span> <span class="n">deps</span> <span class="k">do</span>
  <span class="p">[</span>
    <span class="p">{</span><span class="ss">:cowboy</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 2.0"</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:plug</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 1.0"</span><span class="p">}</span>
    <span class="c1"># {:dep_from_hexpm, "~&gt; 0.3.0"},</span>
    <span class="c1"># {:dep_from_git, git: "https://github.com/elixir-lang/my_dep.git", tag: "0.1.0"},</span>
  <span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div>

<p>We add <code class="highlighter-rouge">Plug</code> and <code class="highlighter-rouge">Cowboy</code> as dependencies because <code class="highlighter-rouge">Cowboy</code> act as  a web server and
<code class="highlighter-rouge">Plug</code> on the other hand, act as a connection adapter to the web server.</p>

<p>Before we proceed, let’s get all the dependencies first by running the
following command:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mix deps.get
</code></pre></div></div>

<h2 id="using-plug">Using Plug</h2>
<p><code class="highlighter-rouge">Plug</code> can be complicated if we don’t understand it. The
best way to understand it, is to, read the <a href="https://github.com/elixir-plug/plug#hello-world">documentation</a> <em>(In fact, all the
steps mentioned above and below are already available in the documentation)</em>.</p>

<p>So to get a taste of how <code class="highlighter-rouge">Plug</code> works, let’s just copy and paste the code from
the documentation and make some changes. Let’s create <code class="highlighter-rouge">lib/my_plug.ex</code> and
and add in the code.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>touch lib/my_plug.ex
</code></pre></div></div>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">SampleApp</span><span class="o">.</span><span class="no">MyPlug</span> <span class="k">do</span>
  <span class="kn">import</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Conn</span>

  <span class="k">def</span> <span class="n">init</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="k">do</span>
    <span class="c1"># initialize options</span>

    <span class="n">options</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">call</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">_opts</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">conn</span>
    <span class="o">|&gt;</span> <span class="n">put_resp_content_type</span><span class="p">(</span><span class="sd">"</span><span class="s2">text/plain"</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="n">send_resp</span><span class="p">(</span><span class="m">200</span><span class="p">,</span> <span class="sd">"</span><span class="s2">Hello world"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Let’s try to run the code.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iex -S mix

iex(1)&gt; {:ok, _} = Plug.Adapters.Cowboy2.http SampleApp.MyPlug, []
</code></pre></div></div>

<p>Now let’s go and visit <a href="http://localhost:4000" target="_blank">http://localhost:4000</a>.
You should be able to see a “Hello World” on your browser.
We just start the <code class="highlighter-rouge">cowboy</code> web server in <code class="highlighter-rouge">iex</code>, by passing it our <code class="highlighter-rouge">Plug</code> and <code class="highlighter-rouge">[]</code>
empty arguments.</p>

<h2 id="thats-all">That’s all</h2>
<p>Yes, you have wrote a simple web server using Elixir.</p>

<p><em>Wait, wait, but how can I run my server through command line? I have to run
<code class="highlighter-rouge">iex -S mix</code> and start the <code class="highlighter-rouge">Cowboy</code> server manually every time?</em></p>

<p><strong>Nope.</strong> We can make it an OTP application. So that we just need to run <code class="highlighter-rouge">mix
run --no-halt</code> or <code class="highlighter-rouge">iex -S mix</code> and the <code class="highlighter-rouge">cowboy</code> server will boot up itself.</p>

<h2 id="basic-of-otp-application">Basic of OTP Application</h2>

<p>OTP application is basically a component that has predefined behaviour. It can
be started, loaded or stopped. To create an OTP application in Elixir, we
use the <code class="highlighter-rouge">Application</code> module and implements some of the expected behavior. For
more you can always refer to the documentation of <a href="https://hexdocs.pm/elixir/Application.html">Application</a>.</p>

<p>So let’s create a simple application first.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>touch lib/app.ex
</code></pre></div></div>
<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">SampleApp</span><span class="o">.</span><span class="no">App</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Application</span>
  <span class="k">def</span> <span class="n">start</span><span class="p">(</span><span class="n">_type</span><span class="p">,</span> <span class="n">_args</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">IO</span><span class="o">.</span><span class="n">puts</span> <span class="sd">"</span><span class="s2">Starting application"</span>
    <span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="no">Supervisor</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="ss">strategy:</span> <span class="ss">:one_for_one</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now if you run <code class="highlighter-rouge">mix run --no-halt</code>, you still won’t see the “Starting
application” output yet. This is because we haven’t configure our <code class="highlighter-rouge">mix.exs</code>
yet.</p>

<p>To make <code class="highlighter-rouge">mix</code> run our application, we have to add the following code into
<code class="highlighter-rouge">mix.exs</code>:</p>
<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">application</span> <span class="k">do</span>
  <span class="p">[</span>
    <span class="ss">extra_applications:</span> <span class="p">[</span><span class="ss">:logger</span><span class="p">],</span>
    <span class="ss">mod:</span> <span class="p">{</span><span class="no">SampleApp</span><span class="o">.</span><span class="no">App</span><span class="p">,</span> <span class="p">[]}</span> <span class="c1"># Add in this line of code</span>
  <span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now, if we run <code class="highlighter-rouge">mix run --no-halt</code>, we can finally see the “Starting
application…” output. It also means we have sucessfully start an OTP
application.</p>

<h2 id="starting-cowboy-server-automatically">Starting Cowboy Server automatically</h2>

<p>Remember how we run our <code class="highlighter-rouge">cowboy</code> server in <code class="highlighter-rouge">iex</code>?</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iex -S mix

iex(1)&gt; {:ok, _} = Plug.Adapters.Cowboy2.http SampleApp.MyPlug, []
</code></pre></div></div>

<p>Now after knowing how to start our OTP application with <code class="highlighter-rouge">mix run --no-halt</code> or
<code class="highlighter-rouge">iex -S mix</code>, we need to start our <code class="highlighter-rouge">cowboy</code> server after our application is
started.</p>

<p>To do this, we need to modify the <code class="highlighter-rouge">start/2</code> method in the <code class="highlighter-rouge">app.ex</code>.</p>
<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">start</span><span class="p">(</span><span class="n">_type</span><span class="p">,</span> <span class="n">_args</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">children</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># Define workers and child supervisors to be supervised</span>
    <span class="no">Plug</span><span class="o">.</span><span class="no">Adapters</span><span class="o">.</span><span class="no">Cowboy2</span><span class="o">.</span><span class="n">child_spec</span><span class="p">(</span><span class="ss">scheme:</span> <span class="ss">:http</span><span class="p">,</span> <span class="ss">plug:</span> <span class="no">SampleApp</span><span class="o">.</span><span class="no">MyPlug</span><span class="p">,</span> <span class="ss">options:</span> <span class="p">[</span><span class="ss">port:</span> <span class="m">4000</span><span class="p">])</span>
  <span class="p">]</span>

  <span class="no">Supervisor</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="ss">strategy:</span> <span class="ss">:one_for_one</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>What we are doing here is to specify the child spec of the child process, which
is our <code class="highlighter-rouge">cowboy</code>. A child specification basically tell the supervisor how to
start, restart or shutdown the child process. The above code is also mentioned
in the documentation of Plug under <a href="https://hexdocs.pm/plug/readme.html#supervised-handlers">Supervised handlers</a>.</p>

<p>Now, if we run the <code class="highlighter-rouge">mix run --no-halt</code>, and visit <a href="http://localhost:4000" target="_blank">http://localhost:4000</a>.</p>

<p>Our web application is now online.</p>

<h2 id="summary">Summary</h2>

<p>If you’re a beginner to OTP or Elixir, there are a lots of stuff underneath
that I didn’t cover well. This is my first blog post on Elixir. It might be lacking.
So here are some other resources you can refer to:</p>

<ul>
  <li><a href="https://elixirschool.com/en/lessons/specifics/plug/">Elixir School Plug</a><a href="#one"><sup>1</sup></a></li>
  <li><a href="https://hexdocs.pm/plug/readme.html">Plug documentation</a></li>
  <li><a href="https://hexdocs.pm/elixir/Application.html">Application documentation</a></li>
  <li><a href="https://hexdocs.pm/elixir/Supervisor.html">Supervisor documentation</a></li>
</ul>

<p><em>The source code of the project is available at <a href="https://github.com/kw7oe/plug_sample_app">GitHub</a>.</em></p>

<hr />
<p><strong>Footnote</strong></p>

<ol>
  <li><small id="one">To be honest, <strong>Elixir School does a better job in explaining this topic</strong>.
The way I’m writing is based on how my thought process flow, so it might be
different and unstructured. This post also covers less topics about using
Plug compared to Elixir School.
</small></li>
</ol>


  </div>

  
</article>

  </main>
</div>

    <footer class="footer">
  <div class="main-col">
    
      <a class="footer-link" href="https://github.com/kw7oe" target="_blank"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">kw7oe</span></a>

    

    
      <a class="footer-link" href="https://twitter.com/kw7oe" target="_blank"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">kw7oe</span></a>

    
  </div>
</footer>

  </body>

</html>
