<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Using Markdown for Static Pages in Rails</title>
  <meta name="description" content="Markdown is great for formatting our writing to be publish as HTML. If you’re a developer, you probably used Markdown before. README of GitHub repositories a...">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://kw7oe.github.io/ruby/rails/2018/11/27/using-markdown-for-static-pages-in-rails.html">
  <link rel="alternate" type="application/rss+xml" title="kw7oe" href="/feed.xml">

  
</head>


  <body>

    

    <div class="section">
  <main class="main-col" aria-label="Content">
    <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Using Markdown for Static Pages in Rails</h1>
    <small class="post-meta">
      <time datetime="2018-11-27T22:04:00+08:00" itemprop="datePublished">
        
        Nov 27, 2018
      </time>
      </small>
  </header>

  <div class="post-content" itemprop="articleBody">
    <p>Markdown is great for formatting our writing to be publish as HTML. If you’re a
developer, you probably used Markdown before. <code class="highlighter-rouge">README</code> of <a href="https://github.com">GitHub</a> repositories
are mostly written in Markdown.</p>

<p>While developing web applications, there will be static pages such as
about page and FAQ page. Most of the time, we have to write it in HTML, which can
be unpleasant.</p>

<p>Luckily, we can still  use Markdown to write the static pages in Rails application
and compile it into HTML.</p>

<h2 id="general-steps">General Steps</h2>

<p>The steps involved are straightforward.</p>

<ol>
  <li>Write Markdown</li>
  <li>Compile the Markdown</li>
  <li>Rails use the compiled HTML to serve the user.</li>
</ol>

<p>There are two approaches:</p>

<ol>
  <li>Compile the Markdown file on runtime, which means, the file is only compiled when
there is a request.</li>
  <li>Precompile the Markdown file into <code class="highlighter-rouge">&lt;filename&gt;.html.erb</code> first.</li>
</ol>

<h2 id="compilation-of-markdown-during-runtime">Compilation of Markdown during runtime</h2>

<p>To compile a Markdown file during runtime in Rails, we need to know how to:</p>

<ul>
  <li>Compile Markdown file in <code class="highlighter-rouge">ruby</code></li>
  <li>Render the compiled HTML as views</li>
  <li>Bind ERB environment if instance variables <code class="highlighter-rouge">@variable</code> is used in the view</li>
</ul>

<p>To compile a Markdown file is fairly straighforward in <code class="highlighter-rouge">ruby</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># gem install kramdown if not found</span>
<span class="nb">require</span> <span class="s1">'kramdown'</span>

<span class="n">file</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s1">'about.md'</span><span class="p">)</span>
<span class="n">html</span> <span class="o">=</span> <span class="no">Kramdown</span><span class="o">::</span><span class="no">Document</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="p">{</span><span class="ss">input: </span><span class="s2">"GFM"</span><span class="p">}).</span><span class="nf">to_html</span>
<span class="c1"># Configuring {input: "GFM"} to set kramdown to use GFM parser</span>
<span class="c1"># instead of the defaut one. GFM parser can parse Github Flavour Markdown.</span>
<span class="nb">p</span> <span class="n">html</span>
<span class="c1">#=&gt; &lt;html&gt;...&lt;/html&gt;</span>
</code></pre></div></div>

<p>To use it in a Rails application:</p>

<p>Add <code class="highlighter-rouge">kramdown</code> to <code class="highlighter-rouge">Gemfile</code></p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gem</span> <span class="s1">'kramdown'</span><span class="p">,</span> <span class="ss">require: </span><span class="kp">false</span>
<span class="c1"># require: false since we are going to require it only</span>
<span class="c1"># when we need it</span>
</code></pre></div></div>

<p>In the <code class="highlighter-rouge">app/views/pages/about.md</code>:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>### Hi, &lt;%= @name %&gt;
</code></pre></div></div>

<p>In the <code class="highlighter-rouge">app/views/pages/about.html.erb</code>:</p>
<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;%=</span> <span class="n">raw</span> <span class="vi">@content</span> <span class="cp">%&gt;</span>
# We want the raw output of the @content instead of escaped
</code></pre></div></div>

<p>In the <code class="highlighter-rouge">app/controllers/pages_controller.rb</code>:</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'kramdown'</span>

<span class="k">class</span> <span class="nc">PagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">about</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">lookup_context</span><span class="p">.</span><span class="nf">find_template</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">controller_path</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">action_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">identifier</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="s2">".html.erb"</span><span class="p">,</span> <span class="s2">".md"</span><span class="p">)</span>
    <span class="vi">@name</span> <span class="o">=</span> <span class="s2">"Kai"</span>

    <span class="c1"># Compiled with ERB</span>
    <span class="n">result</span> <span class="o">=</span> <span class="no">ERB</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
      <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="p">).</span><span class="nf">result</span><span class="p">(</span><span class="nb">binding</span><span class="p">)</span>

    <span class="c1"># Convert MD to HTML</span>
    <span class="vi">@content</span> <span class="o">=</span> <span class="no">Kramdown</span><span class="o">::</span><span class="no">Document</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="p">{</span><span class="ss">input: </span><span class="s2">"GFM"</span><span class="p">}).</span><span class="nf">to_html</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>All the views file are self-explanatory, so let’s just focus on the controller.</p>

<p>First of all, we need to get the <code class="highlighter-rouge">md</code> file in our controller. We can achieive
it by hardcoding it like <code class="highlighter-rouge">file_path = "../views/pages/about.md"</code>. But it is
better to make it dynamically look up the right <code class="highlighter-rouge">md</code> file depending on the
action of the controller.</p>

<p>So we use:</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">template</span> <span class="o">=</span> <span class="n">lookup_context</span><span class="p">.</span><span class="nf">find_template</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">controller_path</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">action_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="c1">#=&gt; app/views/pages/about.html.erb</span>
<span class="n">template</span><span class="p">.</span><span class="nf">identifier</span>
<span class="c1">#=&gt; "/Users/.../app/views/pages/about.html.erb"</span>
<span class="n">template</span><span class="p">.</span><span class="nf">identifier</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="s2">".html.erb"</span><span class="p">,</span> <span class="s2">".md"</span><span class="p">)</span>
<span class="c1">#=&gt; "/Users/.../app/views/pages/about.md"</span>
</code></pre></div></div>

<p>How I know I should use this method to lookup for the file? Google search leads me to this <a href="https://stackoverflow.com/questions/34126212/get-path-of-corresponding-controller-action-view-file">Stackoverflow</a> question and answer.</p>

<p>After that, we need to compile the <code class="highlighter-rouge">md</code> file first with <code class="highlighter-rouge">ERB</code> since we are <code class="highlighter-rouge">erb</code> syntax. After that, we just need to convert the result to HTML using <code class="highlighter-rouge">kramdown</code>.</p>

<p>The benefit of this approach is:</p>

<ul>
  <li>Don’t need to manually compile the <code class="highlighter-rouge">md</code> files.</li>
  <li>Can be used to compile dynamic Markdown files.</li>
</ul>

<h2 id="precompile-the-markdown-file">Precompile the Markdown file</h2>

<p>Another approach, is more troublesome, but has less overhead, since the server don’t need to recompile the same Markdown file everytime someone visit to the page.</p>

<p>Instead of compile during runtime, we compile manually everytime after we
update our Markdown file. Rails just serve the <code class="highlighter-rouge">.html.erb</code> that we
converted from the Markdown files to the visitors.</p>

<p>The steps taken are:</p>

<ul>
  <li>Find all the <code class="highlighter-rouge">.md</code> files in <code class="highlighter-rouge">app/views/pages</code></li>
  <li>Compile every <code class="highlighter-rouge">.md</code> files to <code class="highlighter-rouge">.html.erb</code></li>
</ul>

<p>To do that, we can write a <code class="highlighter-rouge">rake</code> task. Add the following code into your
<code class="highlighter-rouge">Rakefile</code>.</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Get all files in /app/views/page ending with md</span>
<span class="no">SOURCE_FILES</span> <span class="o">=</span> <span class="no">Rake</span><span class="o">::</span><span class="no">FileList</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"app/views/pages/*md"</span><span class="p">)</span>

<span class="c1"># Define a task</span>
<span class="n">task</span> <span class="ss">:compile_md</span> <span class="o">=&gt;</span> <span class="no">SOURCE_FILES</span><span class="p">.</span><span class="nf">pathmap</span><span class="p">(</span><span class="s2">"%X.html.erb"</span><span class="p">)</span>

<span class="c1"># Define rule for the task</span>
<span class="n">rule</span> <span class="s1">'.html.erb'</span> <span class="o">=&gt;</span> <span class="no">SOURCE_FILES</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="nb">require</span> <span class="s1">'kramdown'</span>
  <span class="n">content</span> <span class="o">=</span> <span class="no">Kramdown</span><span class="o">::</span><span class="no">Document</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">source</span><span class="p">),</span> <span class="p">{</span><span class="ss">input: </span><span class="s2">"GFM"</span><span class="p">}).</span><span class="nf">to_html</span>
  <span class="no">File</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This code block is a bit tricky. To summarize, what it does is scan through all
the <code class="highlighter-rouge">.md</code> files located in <code class="highlighter-rouge">/app/views/page</code> and compile it into <code class="highlighter-rouge">.html.erb</code> if
any changes is made.</p>

<p>We can then run <code class="highlighter-rouge">rake compile_md</code> to manually compile our Markdown file into
<code class="highlighter-rouge">erb</code> file after we updated our Markdown file.</p>

<p>With this approach, do note that we did not handle <code class="highlighter-rouge">erb</code> syntax. Hence, there
is a gotcha. If you need to use <code class="highlighter-rouge">erb</code> syntax, you need to write plain <code class="highlighter-rouge">html</code>
instead. To demonstrate:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>### Hello

This is my first sentence.

Total view:
{::nomarkdown}
&lt;span&gt;&lt;%= view_count %&gt;&lt;/span&gt;
{:/nomarkdown}
</code></pre></div></div>

<p>The benefits of this approach is:</p>

<ul>
  <li>Compilation of Markdown does not happen during runtime. Hence, save some
computation time.</li>
</ul>

<h2 id="summary">Summary</h2>

<p>That’s all. I know there are a lot of magic happening on the <code class="highlighter-rouge">rake</code> task I wrote above.</p>

<p>To further understand the <code class="highlighter-rouge">rake</code> task, I would suggest these tutorials from Avdi
Grimm’s rake series as suggested in <code class="highlighter-rouge">rake</code> README:</p>

<ul>
  <li><a href="http://www.virtuouscode.com/2014/04/21/rake-part-1-basics/">Rake Basics</a></li>
  <li><a href="http://www.virtuouscode.com/2014/04/22/rake-part-2-file-lists/">Rake File Lists</a></li>
  <li><a href="http://www.virtuouscode.com/2014/04/23/rake-part-3-rules/">Rake Rules</a></li>
</ul>

<p>A sample application for this post can be found at my <a href="https://github.com/kw7oe/sample-md-static-pages">Github</a>.</p>

<hr />

<p><strong>Footnote</strong></p>

<ol>
  <li><small>I am sorry if this post is a bit messy. I am still not quite good at writing and structuring lengthy tutorial.</small></li>
</ol>


  </div>

  
    

  <div id="disqus_thread"></div>
  <script>
    var disqus_config = function () {
      this.page.url = 'https://kw7oe.github.io/ruby/rails/2018/11/27/using-markdown-for-static-pages-in-rails.html';
      this.page.identifier = 'https://kw7oe.github.io/ruby/rails/2018/11/27/using-markdown-for-static-pages-in-rails.html';
    };

    (function() {
      var d = document, s = d.createElement('script');

      s.src = 'https://kw7oe-github-io.disqus.com/embed.js';

      s.setAttribute('data-timestamp', +new Date());
      (d.head || d.body).appendChild(s);
    })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


  
</article>

  </main>
</div>

    
    <script src="/assets/custom.js"></script>
  </body>

</html>
