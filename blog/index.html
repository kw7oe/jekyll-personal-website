<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Blog</title>
  <meta name="description" content="To be figured out soon.">

  <link rel="stylesheet" href="/assets/main.css">
  <link rel="canonical" href="https://kw7oe.github.io/blog/">
  <link rel="alternate" type="application/rss+xml" title="kw7oe" href="/feed.xml">

  
</head>


  <body>
    
    <header class="site-header" role="banner">
  <div class="main-col">
    
    

    
      <nav class="navbar" role="navigation"
        aria-label="main navigation">
        

<div class="navbar-brand">
<a href="/"
   >
  Home
</a>
</div>

        

<div class="navbar-item">
<a href="/categories"
   >
  Categories
</a>
</div>

        

<div class="navbar-item">
<a href="/about"
   >
  About
</a>
</div>

        

<div class="navbar-item">
<a href="/resume"
   >
  Resume
</a>
</div>

      </nav>
      
  </div>
</header>

    
    <div class="section">
  <main class="main-col" aria-label="Content">
    <article class="blog">
  
    <div class="post">
  <!-- Headeer -->
   <header class="post-header">
     <h1 class="post-title" itemprop="name headline">Advent of Code 2018: Day 1 Part 2, How I improve my solution by 34x faster</h1>
     <p class="post-meta">
       <time datetime="2018-12-01T22:10:00+08:00" itemprop="datePublished">
         
         Dec 1, 2018
       </time>
       </p>
   </header>

   <!-- Main Article -->
   <div class="post-content" itemprop="articleBody">
     <p>In the <a href="/aoc/elixir/2018/12/01/advent-of-code-2018-day-1-part-1.html">previous post</a>, we had briefly discuss about the solution of Part 1. It
is fairly straightforward. I thought Part 2 is going to be easy too. But man,
I was wrong. It is a bit tricky.</p>

<p><strong>My initial solution takes around 17 seconds to compute the answer</strong>.  I
<strong>made it 34x faster</strong> by changing the data structure. In the end,
the improved solution solves the puzzle in just <strong>0.5 seconds</strong>.</p>

<p><em>Code is available at <a href="https://github.com/kw7oe/advent-of-code-2018">GitHub</a>. For those who just want to know how the solution
improved by 34x faster, see <a href="#three">here</a>.</em></p>

<p>Okay, that’s the end of some irrelavant stuff. Let’s jump straight to the puzzle of Part 2.</p>

<h2 id="part-2">Part 2</h2>

<p>Part 2 still uses the same inputs as Part 1.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-9
+7 +5
-13
+6
...
-23
-46
-27
-11
-75223
</code></pre></div></div>

<p>This time, the question and scenario are abit different, which make it
tricky.</p>

<p>The problem description states that:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>You notice that the device repeats the same frequency change list over and over. To calibrate the device, you need to find the first frequency it reaches twice.
</code></pre></div></div>

<p><strong>For example:</strong></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Here are other examples:

    +1, -1 first reaches 0 twice.
    +3, +3, +4, -2, -4 first reaches 10 twice.
    -6, +3, +8, +5, -6 first reaches 5 twice.
    +7, +7, -2, -7, -4 first reaches 14 twice.

Note that your device might need to repeat its list of frequency changes many times before a duplicate frequency is found, and that duplicates might be found while in the middle of processing the list.
</code></pre></div></div>

<p>And the question is:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>What is the first frequency your device reaches twice?
</code></pre></div></div>

<h3 id="problem-breakdown">Problem Breakdown</h3>

<p>So the question is asking for the first frequency that reaches twice. But, do
note that <strong>the frequency list can be repeated many times before an asnwer is
found</strong>.</p>

<p>If after the first interation of the frequency list, there is no duplicate
found, the frequency list will go through the second interation again. This
only stops until a duplicate frequency found.</p>

<p>To summarize:</p>

<ul>
  <li>Find first duplicate of frequency.</li>
  <li>Repeat the frequency list if no duplicate frequency found. <a href="#one"><sup>1</sup></a></li>
  <li>The initial frequency is 0.</li>
  <li>Upon second iteration, the current frequency will be resumed from the previosu
iteration. <a href="#two"><sup>2</sup></a></li>
</ul>

<h3 id="initial-solution">Initial Solution</h3>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">Finder</span> <span class="k">do</span>
  <span class="k">def</span> <span class="n">is_duplicate?</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">appeared_frequencies</span><span class="p">)</span> <span class="k">do</span>
    <span class="c1"># Check if the frequency is duplicate in appeared_frequencies</span>
    <span class="k">if</span> <span class="no">Enum</span><span class="o">.</span><span class="n">member?</span><span class="p">(</span><span class="n">appeared_frequencies</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span> <span class="k">do</span>

      <span class="c1"># Return :halt to halt the reduce_while loop</span>
      <span class="c1"># and the duplicate</span>
      <span class="p">{</span><span class="ss">:halt</span><span class="p">,</span> <span class="n">frequency</span><span class="p">}</span>
    <span class="k">else</span>
      <span class="c1"># Update the appeared_frequencies to include the new frequency</span>

      <span class="c1"># Prepend [ element_to_add | rest_of_list ] is used since it</span>
      <span class="c1"># has a constant time of adding element to list.</span>
      <span class="n">appeared_frequencies</span> <span class="o">=</span> <span class="p">[</span> <span class="n">frequency</span> <span class="o">|</span> <span class="n">appeared_frequencies</span> <span class="p">]</span>

      <span class="c1"># Return :cont to continue the reduce_while loop</span>
      <span class="c1"># with the frequency and updated appeared_frequencies</span>
      <span class="p">{</span><span class="ss">:cont</span><span class="p">,</span> <span class="p">{</span><span class="n">frequency</span><span class="p">,</span> <span class="n">appeared_frequencies</span><span class="p">}}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">accumulate_and_find</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">past_frequencies</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">frequencies</span>
     <span class="c1"># The accumulator for reduce_while is:</span>

     <span class="c1">#   initial/prev_frequency -&gt; Initial/Previous Frequency,</span>
     <span class="c1">#   past_frequencies/appeared_frequencies -&gt; Past Appeared Frequencies /</span>
     <span class="c1">#                                            Appeared Frequencies</span>
    <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">reduce_while</span><span class="p">({</span><span class="n">initial</span><span class="p">,</span> <span class="n">past_frequencies</span><span class="p">},</span>
      <span class="k">fn</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">{</span><span class="n">prev_frequency</span><span class="p">,</span> <span class="n">appeared_frequencies</span><span class="p">})</span>  <span class="o">-&gt;</span>

        <span class="c1"># Calculate the new frequency.</span>
        <span class="n">new_frequency</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">prev_frequency</span>

        <span class="c1"># Check if the new frequency is a duplicate</span>

        <span class="c1"># Halt if it is.</span>
        <span class="c1"># Continue the reduce_while if it is not.</span>
        <span class="n">is_duplicate?</span><span class="p">(</span><span class="n">new_frequency</span><span class="p">,</span> <span class="n">appeared_frequencies</span><span class="p">)</span>
      <span class="k">end</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">find_first_duplicate_frequency</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">past_frequencies</span><span class="p">)</span> <span class="k">do</span>
    <span class="k">case</span> <span class="n">accumulate_and_find</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">past_frequencies</span><span class="p">)</span> <span class="k">do</span>
      <span class="c1"># No duplicates found</span>
      <span class="p">{</span><span class="n">result</span><span class="p">,</span> <span class="n">appeared_frequencies</span><span class="p">}</span> <span class="o">-&gt;</span>
        <span class="c1"># Recursively call this method</span>
        <span class="c1"># by passing in the frequencies again.</span>

        <span class="c1"># However, the next iteration `initial` frequency will be the previous</span>
        <span class="c1"># iteration frequency, which is the value of `result`.</span>

        <span class="c1"># The `appeared_frequencies in the previous iteration will be pass</span>
        <span class="c1"># forward to the next iteration too.</span>

        <span class="n">find_first_duplicate_frequency</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">appeared_frequencies</span><span class="p">)</span>

      <span class="c1"># Duplicate found</span>
      <span class="n">result</span> <span class="o">-&gt;</span> <span class="n">result</span> <span class="c1"># Return duplicate and end recursive call.</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">case</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="sd">"</span><span class="s2">input.txt"</span><span class="p">)</span> <span class="k">do</span>
  <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">content</span><span class="p">}</span> <span class="o">-&gt;</span>
    <span class="n">frequencies</span> <span class="o">=</span> <span class="n">content</span>
                  <span class="o">|&gt;</span> <span class="no">String</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                  <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="no">String</span><span class="o">.</span><span class="n">to_integer</span><span class="o">/</span><span class="m">1</span><span class="p">)</span>

    <span class="no">Finder</span><span class="o">.</span><span class="n">find_first_duplicate_frequency</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="p">[</span><span class="m">0</span><span class="p">])</span>
    <span class="o">|&gt;</span> <span class="no">IO</span><span class="o">.</span><span class="n">inspect</span>
  <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="n">_</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="no">IO</span><span class="o">.</span><span class="n">puts</span> <span class="sd">"</span><span class="s2">Error opening files"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If the comments in the code is not sufficient, here are the more detailed
explanation to help you understand the code <em>(hopefully)</em>:</p>

<ol>
  <li>First, same as Part 1, we read the content from the file, split it and
conver every element into integer first.</li>
  <li>Then, we pass it into <code class="highlighter-rouge">Finder.find_first_duplicate_frequency/3</code> method,
with the <code class="highlighter-rouge">frequencies</code>, initial frequency, and appeared frequencies.</li>
  <li>In <code class="highlighter-rouge">ind_first_duplicate_frequency</code>, it will delegate the finding
duplicate job to <code class="highlighter-rouge">accumulate_and_find/3</code> and check if the return result
is a found duplicate or not.
    <ul>
      <li>If there is no duplicate found, it will call itself recursively, with the same <code class="highlighter-rouge">frequencies</code>,
to start the next iteration.</li>
      <li>The initial frequency will be replaced with the last frequency from the previous iteration.</li>
      <li>The appeared frequencies from the previous iteration will also be pass forward
to the next iteration.</li>
    </ul>
  </li>
  <li>In <code class="highlighter-rouge">accumulate_and_find/3</code>, we use <code class="highlighter-rouge">Map.reduce_while/3</code> to map through each
elements in the <code class="highlighter-rouge">frequencies</code> and keep track of the previous frequency and
appeared frequencies.
    <ul>
      <li><code class="highlighter-rouge">reduce_while/3</code> is used so that we can control when to <code class="highlighter-rouge">halt</code> the
 looping.</li>
      <li>It accepts an accumulator, which in this case is our <code class="highlighter-rouge">{ initial,
past_frequencies }</code>, which indicates the state we want to keep track of
while mapping through the elements</li>
      <li>It also accepts a function, which in this case, will be used to calculate
the new frequency, by <code class="highlighter-rouge">new_frequency = x + prev_frequency</code> and check
if it is a duplicate using <code class="highlighter-rouge">is_duplicate?/2</code>.</li>
    </ul>
  </li>
  <li>In <code class="highlighter-rouge">is_duplicate?/2</code>, it basically check if the element already existed
by <code class="highlighter-rouge">Enum.member/2?</code>.
    <ul>
      <li>If it exists, it return <code class="highlighter-rouge">:halt</code> and the duplicate to the <code class="highlighter-rouge">reduce_while</code>
code block. Thus, ending the loop.</li>
      <li>Else, it return <code class="highlighter-rouge">:cont</code> with the current frequency and the new appeared
frequencies to the <code class="highlighter-rouge">reduce_while/3</code> code block.</li>
    </ul>
  </li>
</ol>

<p><strong>Performance:</strong></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ time elixir part-2.ex

real	0m17.047s
user	0m16.978s
sys	0m0.184s
</code></pre></div></div>

<p>At first, I thought I am having infinity loop and was kind of disappointed as
it was my forth time fixing the solution. Then, I jrealized, it
just take a long time to compute the answer.</p>

<p>After a few hours, I started to think about how to
improve the performance. Then, I realized why it took so long.</p>

<h3 id="improved-solution">Improved Solution</h3>
<p>It is beacuse of the use of <code class="highlighter-rouge">List</code>. <code class="highlighter-rouge">Enum.member?/2</code> will iterate through every
single element until it find the member. So, when there is a new element
added to <code class="highlighter-rouge">appeared_frequency</code>, it has to loop through additional element in the
<code class="highlighter-rouge">Enum.member?/2</code>.</p>

<p>Looping through the <code class="highlighter-rouge">frequencies</code> itself is already an <em>O(n)</em> operation. With,
 <code class="highlighter-rouge">Enum.member?/2</code>, that’s another <em>O(n)</em> operation.Thus, resulting in a <em>O(n^2)</em>
 solution.</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">Finder</span> <span class="k">do</span>

  <span class="k">def</span> <span class="n">is_duplicate?</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">appeared_frequencies</span><span class="p">)</span> <span class="k">do</span>
    <span class="c1"># Use Map.has_key?/2 to check if the frequency already existed</span>
    <span class="k">if</span> <span class="no">Map</span><span class="o">.</span><span class="n">has_key?</span><span class="p">(</span><span class="n">appeared_frequencies</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span> <span class="k">do</span>
      <span class="p">{</span><span class="ss">:halt</span><span class="p">,</span> <span class="n">frequency</span><span class="p">}</span>
    <span class="k">else</span>
      <span class="c1"># Use Map.put/3 to add the new frequency in to the map.</span>
      <span class="n">appeared_frequencies</span> <span class="o">=</span> <span class="no">Map</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">appeared_frequencies</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="m">0</span><span class="p">)</span>
      <span class="p">{</span><span class="ss">:cont</span><span class="p">,</span> <span class="p">{</span><span class="n">frequency</span><span class="p">,</span> <span class="n">appeared_frequencies</span><span class="p">}}</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">accumulate_and_find</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">past_frequencies</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">frequencies</span>
    <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">reduce_while</span><span class="p">({</span><span class="n">initial</span><span class="p">,</span> <span class="n">past_frequencies</span><span class="p">},</span>
      <span class="k">fn</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">{</span><span class="n">prev_frequency</span><span class="p">,</span> <span class="n">appeared_frequencies</span><span class="p">})</span>  <span class="o">-&gt;</span>
        <span class="n">new_frequency</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">prev_frequency</span>
        <span class="n">is_duplicate?</span><span class="p">(</span><span class="n">new_frequency</span><span class="p">,</span> <span class="n">appeared_frequencies</span><span class="p">)</span>
      <span class="k">end</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">find_first_duplicate_frequency</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">past_frequencies</span><span class="p">)</span> <span class="k">do</span>
    <span class="k">case</span> <span class="n">accumulate_and_find</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">past_frequencies</span><span class="p">)</span> <span class="k">do</span>
      <span class="p">{</span><span class="n">result</span><span class="p">,</span> <span class="n">appeared_frequencies</span><span class="p">}</span> <span class="o">-&gt;</span>
        <span class="n">find_first_duplicate_frequency</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">appeared_frequencies</span><span class="p">)</span>
      <span class="n">result</span> <span class="o">-&gt;</span> <span class="n">result</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>


<span class="k">case</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="sd">"</span><span class="s2">input.txt"</span><span class="p">)</span> <span class="k">do</span>
  <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">content</span><span class="p">}</span> <span class="o">-&gt;</span>
    <span class="n">frequencies</span> <span class="o">=</span> <span class="n">content</span>
                  <span class="o">|&gt;</span> <span class="no">String</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                  <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="no">String</span><span class="o">.</span><span class="n">to_integer</span><span class="o">/</span><span class="m">1</span><span class="p">)</span>

    <span class="c1"># Subsitute [0] to %{0 =&gt; 0} to represent the appeared frequencies.</span>
    <span class="no">Finder</span><span class="o">.</span><span class="n">find_first_duplicate_frequency</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="p">%{</span><span class="m">0</span> <span class="o">=&gt;</span> <span class="m">0</span><span class="p">})</span>
    <span class="o">|&gt;</span> <span class="no">IO</span><span class="o">.</span><span class="n">inspect</span>
  <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="n">_</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="no">IO</span><span class="o">.</span><span class="n">puts</span> <span class="sd">"</span><span class="s2">Error opening files"</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The second solution is just to switch the data structure we used to store the
<code class="highlighter-rouge">appeared_frequencies</code>. Instead of <code class="highlighter-rouge">List</code>, we use a <code class="highlighter-rouge">Map</code>. <code class="highlighter-rouge">Map</code> has a
constant look up time <em>O(1)</em> to access the element. Hence, it improve the
performance of the solution.</p>

<p><em>By using the right data structure, with a change of 3 lines of code,
we successfully improve the execution speed of our program by <strong>34x</strong> faster.</em></p>

<p><strong>Performance:</strong></p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ time elixir part-2.ex

real	0m0.517s
user	0m0.481s
sys	0m0.188s
</code></pre></div></div>

<p>Day 1 Part 2, Done.</p>

<hr />
<p><strong>Footnote</strong></p>

<ol>
  <li><small id="one">
At first, I didn’t notice this and submitted the wrong answer.
</small></li>
  <li><small id="two">
Then I submitted the wrong answer again, as I didn’t use the last frequency
from the previous iteration while starting the next iteration…
</small></li>
  <li><small id="three">I replace the data structure to keep track
of the appeared frequencies <em>(which required lookup)</em> from <code class="highlighter-rouge">List</code> to <code class="highlighter-rouge">Map</code>.
</small></li>
</ol>


   </div>
</div>
    <hr>
  
    <div class="post">
  <!-- Headeer -->
   <header class="post-header">
     <h1 class="post-title" itemprop="name headline">Advent of Code 2018: Day 1 Part 1</h1>
     <p class="post-meta">
       <time datetime="2018-12-01T21:47:00+08:00" itemprop="datePublished">
         
         Dec 1, 2018
       </time>
       </p>
   </header>

   <!-- Main Article -->
   <div class="post-content" itemprop="articleBody">
     <p>Advent of Code (AOC) 2018 has finally arrived. This is the first time I participate
in AOC. Last year, when I first heard of AOC, I wanted to participate in it.
But due to heavy workload from university, I just give up on doing it.</p>

<p>This year, it’s different, I had graduated and working remotely. Hence, this
year, I can schedule some time to work on this event. I am going to use
<code class="highlighter-rouge">Elixir</code> to solve the puzzles this year. The codes will be available to
my <a href="https://github.com/kw7oe/advent-of-code-2018">GitHub repo</a>.</p>

<p>If things go well, I might continue writing down my journey on solving
the puzzles of AOC 2018.</p>

<p>Without further ado, let’s start discussing the <a href="https://adventofcode.com/2018/day/1">puzzles of Day 1</a>.</p>

<h2 id="part-1">Part 1</h2>

<p>Part 1 is straightforward. A list of frequencies will given, and we have to sum up
the frequencies. For example, from the problem descriptions:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Here are other example situations:

    +1, +1, +1 results in  3
    +1, +1, -2 results in  0
    -1, -2, -3 results in -6
</code></pre></div></div>

<p>So, the question of part 1 is:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Starting with a frequency of zero, what is the resulting frequency after all of the changes in frequency have been applied?
</code></pre></div></div>

<p>Straight forward and easy right?</p>

<p><strong>So here is the puzzle inputs:</strong></p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>-9
+7
+5
-13
+6
...
-23
-46
-27
-11
-75223
</code></pre></div></div>

<p><strong>Solution:</strong></p>
<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">case</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="sd">"</span><span class="s2">input.txt"</span><span class="p">)</span> <span class="k">do</span>
  <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">content</span><span class="p">}</span> <span class="o">-&gt;</span>
    <span class="n">content</span>
    <span class="o">|&gt;</span> <span class="no">String</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
    <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="no">String</span><span class="o">.</span><span class="n">to_integer</span><span class="o">/</span><span class="m">1</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="no">Enum</span><span class="o">.</span><span class="n">sum</span>
    <span class="o">|&gt;</span> <span class="no">IO</span><span class="o">.</span><span class="n">inspect</span>
  <span class="p">{</span><span class="ss">:error</span><span class="p">,</span> <span class="n">_</span><span class="p">}</span> <span class="o">-&gt;</span> <span class="no">IO</span><span class="o">.</span><span class="n">puts</span> <span class="sd">"</span><span class="s2">Error opening files"</span>
<span class="k">end</span>
</code></pre></div></div>

<ol>
  <li>First, we read in the input from <code class="highlighter-rouge">input.txt</code> using <code class="highlighter-rouge">File.read/1</code></li>
  <li>Next, we split the content by newline using <code class="highlighter-rouge">String.split/1</code>.
Now, we have a list of string representing the frequency.</li>
  <li>Then, we map through the list with <code class="highlighter-rouge">Enum.map/2</code> and convert the string
to integer using <code class="highlighter-rouge">String.to_integer/1</code>.</li>
  <li>Lastly, we call <code class="highlighter-rouge">Enum.sum/2</code> to sum frequencies, which loops through every
element in the list and add it up.</li>
</ol>

<p><strong>Performance:</strong>
It takes around 0.3 seconds to compute the answer.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ time elixir part-1.ex

real	0m0.350s
user	0m0.321s
sys	0m0.155s
</code></pre></div></div>

<p>Day 1 Part 1, Done.</p>

<hr />
<p><em>Read Part 2 <a href="/aoc/elixir/2018/12/01/advent-of-code-2018-day-1-part-2.html">here</a>.</em></p>


   </div>
</div>
    <hr>
  
    <div class="post">
  <!-- Headeer -->
   <header class="post-header">
     <h1 class="post-title" itemprop="name headline">Using Markdown for Static Pages in Rails</h1>
     <p class="post-meta">
       <time datetime="2018-11-27T22:04:00+08:00" itemprop="datePublished">
         
         Nov 27, 2018
       </time>
       </p>
   </header>

   <!-- Main Article -->
   <div class="post-content" itemprop="articleBody">
     <p>Markdown is great for formatting our writing to be publish as HTML. If you’re a
developer, you probably used Markdown before. <code class="highlighter-rouge">README</code> of <a href="https://github.com">GitHub</a> repositories
are mostly written in Markdown.</p>

<p>While developing web applications, there will be static pages such as
about page and FAQ page. Most of the time, we have to write it in HTML, which can
be unpleasant.</p>

<p>Luckily, we can still  use Markdown to write the static pages in Rails application
and compile it into HTML.</p>

<h2 id="general-steps">General Steps</h2>

<p>The steps involved are straightforward.</p>

<ol>
  <li>Write Markdown</li>
  <li>Compile the Markdown</li>
  <li>Rails use the compiled HTML to serve the user.</li>
</ol>

<p>There are two approaches:</p>

<ol>
  <li>Compile the Markdown file on runtime, which means, the file is only compiled when
there is a request.</li>
  <li>Precompile the Markdown file into <code class="highlighter-rouge">&lt;filename&gt;.html.erb</code> first.</li>
</ol>

<h2 id="compilation-of-markdown-during-runtime">Compilation of Markdown during runtime</h2>

<p>To compile a Markdown file during runtime in Rails, we need to know how to:</p>

<ul>
  <li>Compile Markdown file in <code class="highlighter-rouge">ruby</code></li>
  <li>Render the compiled HTML as views</li>
  <li>Bind ERB environment if instance variables <code class="highlighter-rouge">@variable</code> is used in the view</li>
</ul>

<p>To compile a Markdown file is fairly straighforward in <code class="highlighter-rouge">ruby</code>:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># gem install kramdown if not found</span>
<span class="nb">require</span> <span class="s1">'kramdown'</span>

<span class="n">file</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s1">'about.md'</span><span class="p">)</span>
<span class="n">html</span> <span class="o">=</span> <span class="no">Kramdown</span><span class="o">::</span><span class="no">Document</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="p">{</span><span class="ss">input: </span><span class="s2">"GFM"</span><span class="p">}).</span><span class="nf">to_html</span>
<span class="c1"># Configuring {input: "GFM"} to set kramdown to use GFM parser</span>
<span class="c1"># instead of the defaut one. GFM parser can parse Github Flavour Markdown.</span>
<span class="nb">p</span> <span class="n">html</span>
<span class="c1">#=&gt; &lt;html&gt;...&lt;/html&gt;</span>
</code></pre></div></div>

<p>To use it in a Rails application:</p>

<p>Add <code class="highlighter-rouge">kramdown</code> to <code class="highlighter-rouge">Gemfile</code></p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">gem</span> <span class="s1">'kramdown'</span><span class="p">,</span> <span class="ss">require: </span><span class="kp">false</span>
<span class="c1"># require: false since we are going to require it only</span>
<span class="c1"># when we need it</span>
</code></pre></div></div>

<p>In the <code class="highlighter-rouge">app/views/pages/about.md</code>:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>### Hi, &lt;%= @name %&gt;
</code></pre></div></div>

<p>In the <code class="highlighter-rouge">app/views/pages/about.html.erb</code>:</p>
<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;%=</span> <span class="n">raw</span> <span class="vi">@content</span> <span class="cp">%&gt;</span>
# We want the raw output of the @content instead of escaped
</code></pre></div></div>

<p>In the <code class="highlighter-rouge">app/controllers/pages_controller.rb</code>:</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'kramdown'</span>

<span class="k">class</span> <span class="nc">PagesController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
  <span class="k">def</span> <span class="nf">about</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="n">lookup_context</span><span class="p">.</span><span class="nf">find_template</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">controller_path</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">action_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
      <span class="p">.</span><span class="nf">identifier</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="s2">".html.erb"</span><span class="p">,</span> <span class="s2">".md"</span><span class="p">)</span>
    <span class="vi">@name</span> <span class="o">=</span> <span class="s2">"Kai"</span>

    <span class="c1"># Compiled with ERB</span>
    <span class="n">result</span> <span class="o">=</span> <span class="no">ERB</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span>
      <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="p">).</span><span class="nf">result</span><span class="p">(</span><span class="nb">binding</span><span class="p">)</span>

    <span class="c1"># Convert MD to HTML</span>
    <span class="vi">@content</span> <span class="o">=</span> <span class="no">Kramdown</span><span class="o">::</span><span class="no">Document</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="p">{</span><span class="ss">input: </span><span class="s2">"GFM"</span><span class="p">}).</span><span class="nf">to_html</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>All the views file are self-explanatory, so let’s just focus on the controller.</p>

<p>First of all, we need to get the <code class="highlighter-rouge">md</code> file in our controller. We can achieive
it by hardcoding it like <code class="highlighter-rouge">file_path = "../views/pages/about.md"</code>. But it is
better to make it dynamically look up the right <code class="highlighter-rouge">md</code> file depending on the
action of the controller.</p>

<p>So we use:</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">template</span> <span class="o">=</span> <span class="n">lookup_context</span><span class="p">.</span><span class="nf">find_template</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">controller_path</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">action_name</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="c1">#=&gt; app/views/pages/about.html.erb</span>
<span class="n">template</span><span class="p">.</span><span class="nf">identifier</span>
<span class="c1">#=&gt; "/Users/.../app/views/pages/about.html.erb"</span>
<span class="n">template</span><span class="p">.</span><span class="nf">identifier</span><span class="p">.</span><span class="nf">sub</span><span class="p">(</span><span class="s2">".html.erb"</span><span class="p">,</span> <span class="s2">".md"</span><span class="p">)</span>
<span class="c1">#=&gt; "/Users/.../app/views/pages/about.md"</span>
</code></pre></div></div>

<p>How I know I should use this method to lookup for the file? Google search leads me to this <a href="https://stackoverflow.com/questions/34126212/get-path-of-corresponding-controller-action-view-file">Stackoverflow</a> question and answer.</p>

<p>After that, we need to compile the <code class="highlighter-rouge">md</code> file first with <code class="highlighter-rouge">ERB</code> since we are <code class="highlighter-rouge">erb</code> syntax. After that, we just need to convert the result to HTML using <code class="highlighter-rouge">kramdown</code>.</p>

<p>The benefit of this approach is:</p>

<ul>
  <li>Don’t need to manually compile the <code class="highlighter-rouge">md</code> files.</li>
  <li>Can be used to compile dynamic Markdown files.</li>
</ul>

<h2 id="precompile-the-markdown-file">Precompile the Markdown file</h2>

<p>Another approach, is more troublesome, but has less overhead, since the server don’t need to recompile the same Markdown file everytime someone visit to the page.</p>

<p>Instead of compile during runtime, we compile manually everytime after we
update our Markdown file. Rails just serve the <code class="highlighter-rouge">.html.erb</code> that we
converted from the Markdown files to the visitors.</p>

<p>The steps taken are:</p>

<ul>
  <li>Find all the <code class="highlighter-rouge">.md</code> files in <code class="highlighter-rouge">app/views/pages</code></li>
  <li>Compile every <code class="highlighter-rouge">.md</code> files to <code class="highlighter-rouge">.html.erb</code></li>
</ul>

<p>To do that, we can write a <code class="highlighter-rouge">rake</code> task. Add the following code into your
<code class="highlighter-rouge">Rakefile</code>.</p>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Get all files in /app/views/page ending with md</span>
<span class="no">SOURCE_FILES</span> <span class="o">=</span> <span class="no">Rake</span><span class="o">::</span><span class="no">FileList</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s2">"app/views/pages/*md"</span><span class="p">)</span>

<span class="c1"># Define a task</span>
<span class="n">task</span> <span class="ss">:compile_md</span> <span class="o">=&gt;</span> <span class="no">SOURCE_FILES</span><span class="p">.</span><span class="nf">pathmap</span><span class="p">(</span><span class="s2">"%X.html.erb"</span><span class="p">)</span>

<span class="c1"># Define rule for the task</span>
<span class="n">rule</span> <span class="s1">'.html.erb'</span> <span class="o">=&gt;</span> <span class="no">SOURCE_FILES</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
  <span class="nb">require</span> <span class="s1">'kramdown'</span>
  <span class="n">content</span> <span class="o">=</span> <span class="no">Kramdown</span><span class="o">::</span><span class="no">Document</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">source</span><span class="p">),</span> <span class="p">{</span><span class="ss">input: </span><span class="s2">"GFM"</span><span class="p">}).</span><span class="nf">to_html</span>
  <span class="no">File</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="nf">name</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This code block is a bit tricky. To summarize, what it does is scan through all
the <code class="highlighter-rouge">.md</code> files located in <code class="highlighter-rouge">/app/views/page</code> and compile it into <code class="highlighter-rouge">.html.erb</code> if
any changes is made.</p>

<p>We can then run <code class="highlighter-rouge">rake compile_md</code> to manually compile our Markdown file into
<code class="highlighter-rouge">erb</code> file after we updated our Markdown file.</p>

<p>With this approach, do note that we did not handle <code class="highlighter-rouge">erb</code> syntax. Hence, there
is a gotcha. If you need to use <code class="highlighter-rouge">erb</code> syntax, you need to write plain <code class="highlighter-rouge">html</code>
instead. To demonstrate:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>### Hello

This is my first sentence.

Total view:
{::nomarkdown}
&lt;span&gt;&lt;%= view_count %&gt;&lt;/span&gt;
{:/nomarkdown}
</code></pre></div></div>

<p>The benefits of this approach is:</p>

<ul>
  <li>Compilation of Markdown does not happen during runtime. Hence, save some
computation time.</li>
</ul>

<h2 id="summary">Summary</h2>

<p>That’s all. I know there are a lot of magic happening on the <code class="highlighter-rouge">rake</code> task I wrote above.</p>

<p>To further understand the <code class="highlighter-rouge">rake</code> task, I would suggest these tutorials from Avdi
Grimm’s rake series as suggested in <code class="highlighter-rouge">rake</code> README:</p>

<ul>
  <li><a href="http://www.virtuouscode.com/2014/04/21/rake-part-1-basics/">Rake Basics</a></li>
  <li><a href="http://www.virtuouscode.com/2014/04/22/rake-part-2-file-lists/">Rake File Lists</a></li>
  <li><a href="http://www.virtuouscode.com/2014/04/23/rake-part-3-rules/">Rake Rules</a></li>
</ul>

<p>A sample application for this post can be found at my <a href="https://github.com/kw7oe/sample-md-static-pages">Github</a>.</p>

<hr />

<p><strong>Footnote</strong></p>

<ol>
  <li><small>I am sorry if this post is a bit messy. I am still not quite good at writing and structuring lengthy tutorial.</small></li>
</ol>


   </div>
</div>
    <hr>
  
    <div class="post">
  <!-- Headeer -->
   <header class="post-header">
     <h1 class="post-title" itemprop="name headline">Minimal Elixir Web Application with Plug and Cowboy</h1>
     <p class="post-meta">
       <time datetime="2018-10-14T15:32:00+08:00" itemprop="datePublished">
         
         Oct 14, 2018
       </time>
       </p>
   </header>

   <!-- Main Article -->
   <div class="post-content" itemprop="articleBody">
     <p>It is interesting to learn things from scratch. Coming from Ruby
background, I was curious what is the equivalent of Sinatra in
Elixir. It’s called Plug. It is what Phoenix build on top of.</p>

<p>Using Sinatra, we can write a quick and simple web server with the following
code:</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require</span> <span class="s1">'sinatra'</span>
<span class="nb">require</span> <span class="s1">'json'</span>

<span class="n">get</span> <span class="s1">'/'</span> <span class="k">do</span>
  <span class="n">content_type</span> <span class="ss">:json</span>
  <span class="no">JSON</span><span class="p">({</span><span class="ss">message: </span><span class="s2">"Hello World"</span><span class="p">})</span>
<span class="k">end</span>
</code></pre></div></div>

<p>How can we achive that in Elixir? With <code class="highlighter-rouge">Plug</code> and <code class="highlighter-rouge">Cowboy</code>.</p>

<h2 id="setup">Setup</h2>

<p><em><strong>NOTE</strong>: This article is based on Elixir v1.7.3</em></p>

<p>First of all, let’s create a <code class="highlighter-rouge">mix</code> project and change directory into it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mix new sample_app
<span class="nb">cd </span>sample_app
</code></pre></div></div>

<p>Open <code class="highlighter-rouge">mix.exs</code> file with your favourite editor. And add the dependencies as
follow:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defp</span> <span class="n">deps</span> <span class="k">do</span>
  <span class="p">[</span>
    <span class="p">{</span><span class="ss">:cowboy</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 2.0"</span><span class="p">},</span>
    <span class="p">{</span><span class="ss">:plug</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 1.0"</span><span class="p">}</span>
    <span class="c1"># {:dep_from_hexpm, "~&gt; 0.3.0"},</span>
    <span class="c1"># {:dep_from_git, git: "https://github.com/elixir-lang/my_dep.git", tag: "0.1.0"},</span>
  <span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div>

<p>We add <code class="highlighter-rouge">Plug</code> and <code class="highlighter-rouge">Cowboy</code> as dependencies because <code class="highlighter-rouge">Cowboy</code> act as  a web server and
<code class="highlighter-rouge">Plug</code> on the other hand, act as a connection adapter to the web server.</p>

<p>Before we proceed, let’s get all the dependencies first by running the
following command:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mix deps.get
</code></pre></div></div>

<h2 id="using-plug">Using Plug</h2>
<p><code class="highlighter-rouge">Plug</code> can be complicated if we don’t understand it. The
best way to understand it, is to, read the <a href="https://github.com/elixir-plug/plug#hello-world">documentation</a> <em>(In fact, all the
steps mentioned above and below are already available in the documentation)</em>.</p>

<p>So to get a taste of how <code class="highlighter-rouge">Plug</code> works, let’s just copy and paste the code from
the documentation and make some changes. Let’s create <code class="highlighter-rouge">lib/my_plug.ex</code> and
and add in the code.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>touch lib/my_plug.ex
</code></pre></div></div>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">SampleApp</span><span class="o">.</span><span class="no">MyPlug</span> <span class="k">do</span>
  <span class="kn">import</span> <span class="no">Plug</span><span class="o">.</span><span class="no">Conn</span>

  <span class="k">def</span> <span class="n">init</span><span class="p">(</span><span class="n">options</span><span class="p">)</span> <span class="k">do</span>
    <span class="c1"># initialize options</span>

    <span class="n">options</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="n">call</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">_opts</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">conn</span>
    <span class="o">|&gt;</span> <span class="n">put_resp_content_type</span><span class="p">(</span><span class="sd">"</span><span class="s2">text/plain"</span><span class="p">)</span>
    <span class="o">|&gt;</span> <span class="n">send_resp</span><span class="p">(</span><span class="m">200</span><span class="p">,</span> <span class="sd">"</span><span class="s2">Hello world"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Let’s try to run the code.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iex -S mix

iex(1)&gt; {:ok, _} = Plug.Adapters.Cowboy2.http SampleApp.MyPlug, []
</code></pre></div></div>

<p>Now let’s go and visit <a href="http://localhost:4000" target="_blank">http://localhost:4000</a>.
You should be able to see a “Hello World” on your browser.
We just start the <code class="highlighter-rouge">cowboy</code> web server in <code class="highlighter-rouge">iex</code>, by passing it our <code class="highlighter-rouge">Plug</code> and <code class="highlighter-rouge">[]</code>
empty arguments.</p>

<h2 id="thats-all">That’s all</h2>
<p>Yes, you have wrote a simple web server using Elixir.</p>

<p><em>Wait, wait, but how can I run my server through command line? I have to run
<code class="highlighter-rouge">iex -S mix</code> and start the <code class="highlighter-rouge">Cowboy</code> server manually every time?</em></p>

<p><strong>Nope.</strong> We can make it an OTP application. So that we just need to run <code class="highlighter-rouge">mix
run --no-halt</code> or <code class="highlighter-rouge">iex -S mix</code> and the <code class="highlighter-rouge">cowboy</code> server will boot up itself.</p>

<h2 id="basic-of-otp-application">Basic of OTP Application</h2>

<p>OTP application is basically a component that has predefined behaviour. It can
be started, loaded or stopped. To create an OTP application in Elixir, we
use the <code class="highlighter-rouge">Application</code> module and implements some of the expected behavior. For
more you can always refer to the documentation of <a href="https://hexdocs.pm/elixir/Application.html">Application</a>.</p>

<p>So let’s create a simple application first.</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>touch lib/app.ex
</code></pre></div></div>
<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">defmodule</span> <span class="no">SampleApp</span><span class="o">.</span><span class="no">App</span> <span class="k">do</span>
  <span class="kn">use</span> <span class="no">Application</span>
  <span class="k">def</span> <span class="n">start</span><span class="p">(</span><span class="n">_type</span><span class="p">,</span> <span class="n">_args</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">IO</span><span class="o">.</span><span class="n">puts</span> <span class="sd">"</span><span class="s2">Starting application"</span>
    <span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="no">Supervisor</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="ss">strategy:</span> <span class="ss">:one_for_one</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now if you run <code class="highlighter-rouge">mix run --no-halt</code>, you still won’t see the “Starting
application” output yet. This is because we haven’t configure our <code class="highlighter-rouge">mix.exs</code>
yet.</p>

<p>To make <code class="highlighter-rouge">mix</code> run our application, we have to add the following code into
<code class="highlighter-rouge">mix.exs</code>:</p>
<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">application</span> <span class="k">do</span>
  <span class="p">[</span>
    <span class="ss">extra_applications:</span> <span class="p">[</span><span class="ss">:logger</span><span class="p">],</span>
    <span class="ss">mod:</span> <span class="p">{</span><span class="no">SampleApp</span><span class="o">.</span><span class="no">App</span><span class="p">,</span> <span class="p">[]}</span> <span class="c1"># Add in this line of code</span>
  <span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div>

<p>Now, if we run <code class="highlighter-rouge">mix run --no-halt</code>, we can finally see the “Starting
application…” output. It also means we have sucessfully start an OTP
application.</p>

<h2 id="starting-cowboy-server-automatically">Starting Cowboy Server automatically</h2>

<p>Remember how we run our <code class="highlighter-rouge">cowboy</code> server in <code class="highlighter-rouge">iex</code>?</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iex -S mix

iex(1)&gt; {:ok, _} = Plug.Adapters.Cowboy2.http SampleApp.MyPlug, []
</code></pre></div></div>

<p>Now after knowing how to start our OTP application with <code class="highlighter-rouge">mix run --no-halt</code> or
<code class="highlighter-rouge">iex -S mix</code>, we need to start our <code class="highlighter-rouge">cowboy</code> server after our application is
started.</p>

<p>To do this, we need to modify the <code class="highlighter-rouge">start/2</code> method in the <code class="highlighter-rouge">app.ex</code>.</p>
<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">start</span><span class="p">(</span><span class="n">_type</span><span class="p">,</span> <span class="n">_args</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">children</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># Define workers and child supervisors to be supervised</span>
    <span class="no">Plug</span><span class="o">.</span><span class="no">Adapters</span><span class="o">.</span><span class="no">Cowboy2</span><span class="o">.</span><span class="n">child_spec</span><span class="p">(</span><span class="ss">scheme:</span> <span class="ss">:http</span><span class="p">,</span> <span class="ss">plug:</span> <span class="no">SampleApp</span><span class="o">.</span><span class="no">MyPlug</span><span class="p">,</span> <span class="ss">options:</span> <span class="p">[</span><span class="ss">port:</span> <span class="m">4000</span><span class="p">])</span>
  <span class="p">]</span>

  <span class="no">Supervisor</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="n">children</span><span class="p">,</span> <span class="ss">strategy:</span> <span class="ss">:one_for_one</span><span class="p">)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>What we are doing here is to specify the child spec of the child process, which
is our <code class="highlighter-rouge">cowboy</code>. A child specification basically tell the supervisor how to
start, restart or shutdown the child process. The above code is also mentioned
in the documentation of Plug under <a href="https://hexdocs.pm/plug/readme.html#supervised-handlers">Supervised handlers</a>.</p>

<p>Now, if we run the <code class="highlighter-rouge">mix run --no-halt</code>, and visit <a href="http://localhost:4000" target="_blank">http://localhost:4000</a>.</p>

<p>Our web application is now online.</p>

<h2 id="summary">Summary</h2>

<p>If you’re a beginner to OTP or Elixir, there are a lots of stuff underneath
that I didn’t cover well. This is my first blog post on Elixir. It might be lacking.
So here are some other resources you can refer to:</p>

<ul>
  <li><a href="https://elixirschool.com/en/lessons/specifics/plug/">Elixir School Plug</a><a href="#one"><sup>1</sup></a></li>
  <li><a href="https://hexdocs.pm/plug/readme.html">Plug documentation</a></li>
  <li><a href="https://hexdocs.pm/elixir/Application.html">Application documentation</a></li>
  <li><a href="https://hexdocs.pm/elixir/Supervisor.html">Supervisor documentation</a></li>
</ul>

<p><em>The source code of the project is available at <a href="https://github.com/kw7oe/plug_sample_app">GitHub</a>.</em></p>

<hr />
<p><strong>Footnote</strong></p>

<ol>
  <li><small id="one">To be honest, <strong>Elixir School does a better job in explaining this topic</strong>.
The way I’m writing is based on how my thought process flow, so it might be
different and unstructured. This post also covers less topics about using
Plug compared to Elixir School.
</small></li>
</ol>


   </div>
</div>
    <hr>
  
    <div class="post">
  <!-- Headeer -->
   <header class="post-header">
     <h1 class="post-title" itemprop="name headline">A note on`application` in mix.exs starting from Elixir 1.4</h1>
     <p class="post-meta">
       <time datetime="2018-10-03T21:45:00+08:00" itemprop="datePublished">
         
         Oct 3, 2018
       </time>
       </p>
   </header>

   <!-- Main Article -->
   <div class="post-content" itemprop="articleBody">
     <p>Starting from Elixir 1.4, we don’t need to specify our application lists in
<code class="highlighter-rouge">application</code>. It is automatically inferred from our dependencies. <em>(Check the
release notes <a href="https://elixir-lang.org/blog/2017/01/05/elixir-v1-4-0-released/">here</a>)</em></p>

<p>Do note that <strong>it only automatically infer the application lists if the
<code class="highlighter-rouge">:applications</code> key is empty.</strong> If you had already declared your it in your
<code class="highlighter-rouge">mix.exs</code> like this:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">application</span> <span class="k">do</span>
  <span class="p">[</span>
    <span class="c1"># Will be automatically inferred starting</span>
    <span class="c1"># from Elixir 1.4, if it is empty.</span>
    <span class="ss">applications:</span> <span class="p">[</span><span class="ss">:cowboy</span><span class="p">,</span> <span class="ss">:plug</span><span class="p">]</span>
  <span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div>
<p>Be sure to clear it to utilize this feature.</p>

<p>Below are the detailed story on how I came across this.</p>

<p><small><em>Disclaimer: The point of this article is summed up above, skip the part below if you’re busy.</em></small></p>

<hr />

<h3 id="the-story">The Story</h3>

<p>Recently, I have been writing a simple Plug web application and came across the
need to use an external database.</p>

<p><code class="highlighter-rouge">Ecto</code> and <code class="highlighter-rouge">PostgreSQl</code> is the thing that come up to my mind.</p>

<p>Hence, I went over the <a href="https://hexdocs.pm/ecto/getting-started.html#content">Ecto documentation</a> and run through the setup in the
application. After going through the steps, and finally run <code class="highlighter-rouge">iex -S mix</code>, an
error arise.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...failed to start child: App.Repo
</code></pre></div></div>

<p>I check my <code class="highlighter-rouge">config.exs</code>. Nothing wrong.</p>

<p>So, I go through the documentation again and again, to check if I miss out anything.
No, nothing wrong. The documentation didn’t mentioned the need to add <code class="highlighter-rouge">ecto</code>
and <code class="highlighter-rouge">postgrex</code> in the <code class="highlighter-rouge">application</code>.  After googling around, someone mentioned
that adding it solve the issues.</p>

<p><em>I tried, it worked.</em></p>

<p>But I don’t know why. <em>The documentation can’t be wrong right?</em></p>

<p>So, I create a new test application and follow the documentation again.</p>

<p><em>And, it works.</em></p>

<p>So, I delete this line of code in my <code class="highlighter-rouge">mix.exs</code>:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="ss">applications:</span> <span class="p">[</span><span class="ss">:cowboy</span><span class="p">,</span> <span class="ss">:plug</span><span class="p">]</span>
</code></pre></div></div>

<p><em>And, it works.</em></p>

<h3 id="the-why">The Why</h3>
<p>Hence, I guess that Mix actaully automatically start the applications needed
for us. So, I search through the documentations of different version of Mix
<em>(<a href="https://hexdocs.pm/mix/1.3.4/Mix.Tasks.Compile.App.html#content">1.4.5</a> vs <a href="https://hexdocs.pm/mix/1.3.4/Mix.Tasks.Compile.App.html#content">1.3.4</a>)</em>, and finally found out that since Elixir 1.4,
Mix has this new feature. It is also mentioned in the <a href="https://elixir-lang.org/blog/2017/01/05/elixir-v1-4-0-released/">release notes of Elixir 1.4</a>.</p>

<p>However there is one condition. <strong>It only automatically infer the applications list if the
<code class="highlighter-rouge">:applications</code> key is empty.</strong> That explains why it didn’t work in my
application because I already declared the list manually, as shown below:</p>

<div class="language-elixir highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="n">application</span> <span class="k">do</span>
  <span class="p">[</span>
    <span class="ss">mod:</span> <span class="p">{</span><span class="no">App</span><span class="o">.</span><span class="no">App</span><span class="p">,</span> <span class="p">[]},</span>
    <span class="ss">extra_applications:</span> <span class="p">[</span><span class="ss">:logger</span><span class="p">],</span>
    <span class="c1"># Can be removed for Elixir &gt;= 1.4.</span>
    <span class="c1"># Since it is automatically inferred.</span>
    <span class="ss">applications:</span> <span class="p">[</span><span class="ss">:cowboy</span><span class="p">,</span> <span class="ss">:plug</span><span class="p">]</span>
  <span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="the-lessons">The Lessons</h3>

<ul>
  <li>Application lists can be automatically inferred in for Elixir &gt;= 1.4</li>
  <li><em>Documentation can be wrong. But, most of the time, you might be the one who
are in fault.</em></li>
  <li>Read release notes.</li>
</ul>

<p>Thanks for reading through it.</p>


   </div>
</div>
    <hr>
  

  
<nav class="pagination is-centered" role="navigation" aria-label="pagination">
  
  <!-- Previous Page -->
  
    <a class="pagination-previous" disabled>Prev</a>
  
  
  <!-- Next Page -->
  
    <a href="/blog/page-2" class="pagination-next">Next &raquo;</a>
  
</div>

</article>

  </main>
</div>
    
    <footer class="footer">
  <div class="main-col">
    
      <a class="footer-link" href="https://github.com/kw7oe" target="_blank"><span class="icon icon--github"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">kw7oe</span></a>

    

    
      <a class="footer-link" href="https://twitter.com/kw7oe" target="_blank"><span class="icon icon--twitter"><svg viewBox="0 0 16 16" width="16px" height="16px"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">kw7oe</span></a>

    
  </div>
</footer>

    <script src="/assets/custom.js"></script> 
  </body>

</html>
